"""
Tests for validation service.

Testy dla serwisu walidacji.
"""

import pytest
from app.services.validation_service import RegeneratorPhysicsValidator, ValidationSeverity


class TestValidationService:
    """Test validation service functionality."""

    @pytest.fixture
    def validator(self) -> ValidationService:
        """Create validation service instance."""
        return ValidationService()

    def test_validate_regenerator_geometry(self, validator: ValidationService):
        """Test regenerator geometry validation."""
        # Valid geometry
        valid_geometry = {
            "length": 10.0,
            "width": 8.0,
            "height": 6.0,
            "wall_thickness": 0.4,
            "checker_height": 0.7,
            "checker_spacing": 0.12
        }

        result = validator.validate_regenerator_geometry(valid_geometry)
        assert result["is_valid"] is True
        assert len(result["errors"]) == 0

        # Invalid geometry - negative values
        invalid_geometry = valid_geometry.copy()
        invalid_geometry["length"] = -5.0

        result = validator.validate_regenerator_geometry(invalid_geometry)
        assert result["is_valid"] is False
        assert len(result["errors"]) > 0
        assert any("negative" in error.lower() for error in result["errors"])

    def test_validate_thermal_properties(self, validator: ValidationService):
        """Test thermal properties validation."""
        # Valid thermal properties
        valid_thermal = {
            "gas_temp_inlet": 1600.0,
            "gas_temp_outlet": 600.0,
            "ambient_temp": 25.0,
            "thermal_conductivity": 2.5,
            "specific_heat": 900.0,
            "density": 2300.0
        }

        result = validator.validate_thermal_properties(valid_thermal)
        assert result["is_valid"] is True
        assert len(result["errors"]) == 0

        # Invalid thermal properties - outlet temp higher than inlet
        invalid_thermal = valid_thermal.copy()
        invalid_thermal["gas_temp_outlet"] = 1700.0  # Higher than inlet

        result = validator.validate_thermal_properties(invalid_thermal)
        assert result["is_valid"] is False
        assert any("outlet temperature" in error.lower() for error in result["errors"])

    def test_validate_flow_parameters(self, validator: ValidationService):
        """Test flow parameters validation."""
        # Valid flow parameters
        valid_flow = {
            "mass_flow_rate": 50.0,
            "cycle_time": 1200.0,
            "pressure_inlet": 101325.0,
            "pressure_outlet": 101000.0
        }

        result = validator.validate_flow_parameters(valid_flow)
        assert result["is_valid"] is True
        assert len(result["errors"]) == 0

        # Invalid flow parameters - negative mass flow rate
        invalid_flow = valid_flow.copy()
        invalid_flow["mass_flow_rate"] = -10.0

        result = validator.validate_flow_parameters(invalid_flow)
        assert result["is_valid"] is False
        assert any("mass flow rate" in error.lower() for error in result["errors"])

    def test_validate_material_properties(self, validator: ValidationService):
        """Test material properties validation."""
        # Valid material properties
        valid_material = {
            "thermal_conductivity": 2.5,
            "specific_heat": 900.0,
            "density": 2300.0,
            "max_temperature": 1600.0,
            "thermal_expansion": 8.5e-6,
            "compressive_strength": 50.0
        }

        result = validator.validate_material_properties(valid_material)
        assert result["is_valid"] is True
        assert len(result["errors"]) == 0

        # Invalid material properties - zero thermal conductivity
        invalid_material = valid_material.copy()
        invalid_material["thermal_conductivity"] = 0.0

        result = validator.validate_material_properties(invalid_material)
        assert result["is_valid"] is False
        assert any("thermal conductivity" in error.lower() for error in result["errors"])

    def test_validate_optimization_constraints(self, validator: ValidationService):
        """Test optimization constraints validation."""
        # Valid constraints
        valid_constraints = {
            "max_pressure_drop": 2000.0,
            "min_thermal_efficiency": 0.2,
            "max_thermal_efficiency": 0.95,
            "min_heat_transfer_coefficient": 50.0,
            "max_wall_temperature": 1800.0
        }

        result = validator.validate_optimization_constraints(valid_constraints)
        assert result["is_valid"] is True
        assert len(result["errors"]) == 0

        # Invalid constraints - min efficiency higher than max
        invalid_constraints = valid_constraints.copy()
        invalid_constraints["min_thermal_efficiency"] = 0.8
        invalid_constraints["max_thermal_efficiency"] = 0.7

        result = validator.validate_optimization_constraints(invalid_constraints)
        assert result["is_valid"] is False
        assert any("minimum" in error.lower() and "maximum" in error.lower() for error in result["errors"])

    def test_validate_physics_ranges(self, validator: ValidationService):
        """Test physics parameter ranges validation."""
        # Valid physics parameters
        valid_physics = {
            "reynolds_number": 5000.0,
            "nusselt_number": 15.0,
            "prandtl_number": 0.7,
            "friction_factor": 0.05,
            "heat_transfer_coefficient": 75.0
        }

        result = validator.validate_physics_ranges(valid_physics)
        assert result["is_valid"] is True
        assert len(result["errors"]) == 0

        # Invalid physics parameters - impossible Nusselt number
        invalid_physics = valid_physics.copy()
        invalid_physics["nusselt_number"] = -5.0  # Negative Nusselt number

        result = validator.validate_physics_ranges(invalid_physics)
        assert result["is_valid"] is False
        assert any("nusselt" in error.lower() for error in result["errors"])

    def test_validate_design_variables(self, validator: ValidationService):
        """Test design variables validation."""
        # Valid design variables
        valid_design_vars = {
            "checker_height": 0.7,
            "checker_spacing": 0.12,
            "wall_thickness": 0.35,
            "thermal_conductivity": 2.5,
            "specific_heat": 900.0,
            "density": 2300.0
        }

        bounds = {
            "checker_height": {"min": 0.1, "max": 2.0},
            "checker_spacing": {"min": 0.05, "max": 0.3},
            "wall_thickness": {"min": 0.1, "max": 1.0},
            "thermal_conductivity": {"min": 0.1, "max": 10.0},
            "specific_heat": {"min": 100.0, "max": 2000.0},
            "density": {"min": 100.0, "max": 5000.0}
        }

        result = validator.validate_design_variables(valid_design_vars, bounds)
        assert result["is_valid"] is True
        assert len(result["errors"]) == 0

        # Invalid design variables - out of bounds
        invalid_design_vars = valid_design_vars.copy()
        invalid_design_vars["checker_height"] = 3.0  # Above max bound

        result = validator.validate_design_variables(invalid_design_vars, bounds)
        assert result["is_valid"] is False
        assert any("bound" in error.lower() for error in result["errors"])

    def test_validate_import_data(self, validator: ValidationService):
        """Test import data validation."""
        # Valid import data
        valid_import_data = {
            "name": "Test Regenerator",
            "regenerator_type": "CROWN",
            "geometry_config": {
                "length": 10.0,
                "width": 8.0,
                "height": 6.0
            },
            "thermal_config": {
                "gas_temp_inlet": 1600.0,
                "gas_temp_outlet": 600.0
            }
        }

        result = validator.validate_import_data(valid_import_data)
        assert result["is_valid"] is True
        assert len(result["errors"]) == 0

        # Invalid import data - missing required fields
        invalid_import_data = valid_import_data.copy()
        del invalid_import_data["name"]

        result = validator.validate_import_data(invalid_import_data)
        assert result["is_valid"] is False
        assert any("required" in error.lower() for error in result["errors"])

    def test_validate_engineering_units(self, validator: ValidationService):
        """Test engineering units validation."""
        # Valid engineering data with proper units
        valid_data = {
            "temperature": {"value": 1600.0, "unit": "celsius"},
            "pressure": {"value": 101325.0, "unit": "pascal"},
            "length": {"value": 10.0, "unit": "meters"},
            "mass_flow": {"value": 50.0, "unit": "kg_per_second"}
        }

        result = validator.validate_engineering_units(valid_data)
        assert result["is_valid"] is True
        assert len(result["errors"]) == 0

        # Invalid engineering data - incompatible units
        invalid_data = valid_data.copy()
        invalid_data["temperature"]["unit"] = "meters"  # Wrong unit type

        result = validator.validate_engineering_units(invalid_data)
        assert result["is_valid"] is False
        assert any("unit" in error.lower() for error in result["errors"])

    def test_validate_regenerator_type_constraints(self, validator: ValidationService):
        """Test regenerator type specific constraints."""
        # Valid Crown regenerator configuration
        crown_config = {
            "regenerator_type": "CROWN",
            "geometry_config": {
                "length": 10.0,
                "width": 8.0,
                "height": 6.0,
                "checker_arrangement": "honeycomb"
            }
        }

        result = validator.validate_regenerator_type_constraints(crown_config)
        assert result["is_valid"] is True

        # Valid End-Port regenerator configuration
        endport_config = {
            "regenerator_type": "END_PORT",
            "geometry_config": {
                "length": 12.0,
                "width": 10.0,
                "height": 8.0,
                "port_diameter": 1.5
            }
        }

        result = validator.validate_regenerator_type_constraints(endport_config)
        assert result["is_valid"] is True

    def test_validate_safety_limits(self, validator: ValidationService):
        """Test safety limits validation."""
        # Valid data within safety limits
        valid_data = {
            "max_temperature": 1600.0,
            "max_pressure": 150000.0,
            "max_stress": 40.0,
            "safety_factor": 2.0
        }

        result = validator.validate_safety_limits(valid_data)
        assert result["is_valid"] is True

        # Invalid data exceeding safety limits
        invalid_data = valid_data.copy()
        invalid_data["max_temperature"] = 2000.0  # Exceeds typical refractory limits

        result = validator.validate_safety_limits(invalid_data)
        assert result["is_valid"] is False
        assert any("safety" in error.lower() or "limit" in error.lower() for error in result["errors"])

    def test_validate_numerical_stability(self, validator: ValidationService):
        """Test numerical stability validation."""
        # Valid numerical values
        valid_values = {
            "reynolds_number": 5000.0,
            "time_step": 0.1,
            "convergence_tolerance": 1e-6,
            "iteration_limit": 1000
        }

        result = validator.validate_numerical_stability(valid_values)
        assert result["is_valid"] is True

        # Invalid numerical values causing instability
        invalid_values = valid_values.copy()
        invalid_values["time_step"] = 1000.0  # Too large time step

        result = validator.validate_numerical_stability(invalid_values)
        assert result["is_valid"] is False

    def test_validate_optimization_algorithm_settings(self, validator: ValidationService):
        """Test optimization algorithm settings validation."""
        # Valid SLSQP settings
        valid_settings = {
            "algorithm": "SLSQP",
            "max_iterations": 100,
            "tolerance": 1e-6,
            "step_size": 0.01,
            "finite_diff_rel_step": 1e-8
        }

        result = validator.validate_optimization_algorithm_settings(valid_settings)
        assert result["is_valid"] is True

        # Invalid settings - zero tolerance
        invalid_settings = valid_settings.copy()
        invalid_settings["tolerance"] = 0.0

        result = validator.validate_optimization_algorithm_settings(invalid_settings)
        assert result["is_valid"] is False

    def test_validate_comprehensive_regenerator_config(self, validator: ValidationService):
        """Test comprehensive regenerator configuration validation."""
        # Complete valid configuration
        complete_config = {
            "name": "Test Regenerator System",
            "regenerator_type": "CROWN",
            "geometry_config": {
                "length": 10.0,
                "width": 8.0,
                "height": 6.0,
                "wall_thickness": 0.4,
                "checker_height": 0.7,
                "checker_spacing": 0.12
            },
            "materials_config": {
                "thermal_conductivity": 2.5,
                "specific_heat": 900.0,
                "density": 2300.0,
                "max_temperature": 1600.0
            },
            "thermal_config": {
                "gas_temp_inlet": 1600.0,
                "gas_temp_outlet": 600.0,
                "ambient_temp": 25.0
            },
            "flow_config": {
                "mass_flow_rate": 50.0,
                "cycle_time": 1200.0,
                "pressure_inlet": 101325.0
            }
        }

        result = validator.validate_comprehensive_regenerator_config(complete_config)
        assert result["is_valid"] is True
        assert len(result["errors"]) == 0
        assert len(result["warnings"]) >= 0  # May have warnings

    def test_validate_with_warnings(self, validator: ValidationService):
        """Test validation that generates warnings but not errors."""
        # Configuration that's valid but not optimal
        suboptimal_config = {
            "checker_height": 0.1,  # Very small, may cause warnings
            "checker_spacing": 0.05,  # Very tight spacing
            "wall_thickness": 0.1,  # Very thin walls
            "thermal_conductivity": 0.1,  # Low conductivity
            "gas_temp_inlet": 800.0,  # Low temperature operation
            "mass_flow_rate": 5.0  # Low flow rate
        }

        result = validator.validate_with_warnings(suboptimal_config)
        assert result["is_valid"] is True  # Still valid
        assert len(result["warnings"]) > 0  # But has warnings

    def test_custom_validation_rules(self, validator: ValidationService):
        """Test custom validation rules."""
        # Define custom rule
        def custom_rule(data):
            if data.get("custom_parameter", 0) < 100:
                return False, "Custom parameter must be at least 100"
            return True, None

        # Valid data for custom rule
        valid_data = {"custom_parameter": 150}
        result = validator.validate_with_custom_rules(valid_data, [custom_rule])
        assert result["is_valid"] is True

        # Invalid data for custom rule
        invalid_data = {"custom_parameter": 50}
        result = validator.validate_with_custom_rules(invalid_data, [custom_rule])
        assert result["is_valid"] is False

    def test_batch_validation(self, validator: ValidationService):
        """Test batch validation of multiple configurations."""
        configs = [
            {"name": "Config 1", "length": 10.0, "width": 8.0},
            {"name": "Config 2", "length": 12.0, "width": 10.0},
            {"name": "Config 3", "length": -5.0, "width": 8.0},  # Invalid
        ]

        results = validator.batch_validate_regenerator_geometry(configs)
        assert len(results) == 3
        assert results[0]["is_valid"] is True
        assert results[1]["is_valid"] is True
        assert results[2]["is_valid"] is False

    def test_validation_error_handling(self, validator: ValidationService):
        """Test validation error handling and reporting."""
        # Test with malformed data
        malformed_data = {
            "temperature": "not_a_number",
            "pressure": None,
            "missing_units": {"value": 100}  # Missing unit field
        }

        with pytest.raises(ValidationError):
            validator.validate_engineering_units(malformed_data)

    def test_performance_validation_thresholds(self, validator: ValidationService):
        """Test performance-based validation thresholds."""
        # High-performance configuration
        high_perf_config = {
            "thermal_efficiency": 0.9,
            "pressure_drop": 500.0,
            "heat_transfer_coefficient": 150.0,
            "fuel_consumption_reduction": 15.0
        }

        result = validator.validate_performance_thresholds(high_perf_config)
        assert result["performance_rating"] == "excellent"

        # Low-performance configuration
        low_perf_config = {
            "thermal_efficiency": 0.6,
            "pressure_drop": 3000.0,
            "heat_transfer_coefficient": 30.0,
            "fuel_consumption_reduction": 2.0
        }

        result = validator.validate_performance_thresholds(low_perf_config)
        assert result["performance_rating"] == "poor"